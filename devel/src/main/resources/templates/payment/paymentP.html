<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>결제 페이지</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
<h1>결제 정보</h1>

<!-- 주문 정보 출력 -->
<div>
  <h2>주문 정보</h2>
  <p><strong>주문 번호:</strong> <span th:text="${order.id}"></span></p>
  <p><strong>주문자:</strong> <span th:text="${order.member.name}"></span></p>
  <p><strong>주문일:</strong> <span th:text="${order.orderDate}"></span></p>
  <p><strong>주문 상태:</strong> <span th:text="${order.orderStatus}"></span></p>
</div>

<!-- 주문 항목 출력 -->
<h2>주문 항목</h2>
<table border="1" cellpadding="10">
  <thead>
  <tr>
    <th>상품명</th>
    <th>가격</th>
    <th>수량</th>
    <th>총 금액</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="orderItem : ${orderItems}">
    <td th:text="${orderItem.biditem != null and orderItem.biditem.bidItemName != null ? orderItem.biditem.bidItemName : orderItem.item != null and orderItem.item.itemNm != null ? orderItem.item.itemNm : '상품명이 없습니다'}"></td>

    <td th:text="${orderItem.orderPrice}"></td> <!-- 가격 -->
    <td th:text="${orderItem.count}"></td> <!-- 수량 -->
    <td th:text="${orderItem.getTotalPrice()}"></td> <!-- 총 금액 -->
  </tr>
  </tbody>
</table>

<!-- 총 결제 금액 -->
<h3>총 금액: <span th:text="${order.totalAmount}"></span> 원</h3>

<hr>

<!-- 결제 버튼 -->
<h3>결제를 진행하세요</h3>
<button id="inicisPay" onclick="handlePayment('html5_inicis.INIpayTest')">통합 결제</button>
<button id="kakaoPay" onclick="handlePayment('kakaopay')">카카오페이 결제</button>

<script>
  var IMP = window.IMP;
  IMP.init("imp14351567");  // 아임포트 가맹점 코드

function handlePayment(pg){
console.log("handlePayment");
console.log("pg");
  $(document).ready(function() {
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");

    var orderId = "[[${order.id}]]"; // orderId를 여기서 처리
    var totalAmount = "[[${order.totalAmount}]]"; // 주문 총액을 여기서 처리
    totalAmount = Number(totalAmount);

      // 결제 요청
      IMP.request_pay({
        pg: pg,   // PG사
        pay_method: "card",               // 결제 수단
        merchant_uid: "order_" + orderId, // 가맹점 주문번호 (유니크해야 함)
        name: "주문번호 " + orderId,       // 상품명
        amount: totalAmount,              // 결제 금액
        buyer_name: "[[${order.member.name}]]", // 구매자 이름
        buyer_tel:"[[${order.member.phone}]]", // 구매자 전화번호
        buyer_email:"[[${order.member.email}]]" // 구매자 이메일
      }, function (rsp) {
        if (rsp.success) {
          alert("결제 완료!");

          // 결제 성공 시 서버로 결제 정보를 전송하여 처리
          $.ajax({
            type: 'POST',
            url: '/payments/validation/' + rsp.imp_uid, // 아임포트 결제 검증 API 호출
            beforeSend: function(xhr) {
              xhr.setRequestHeader(header, token);  // CSRF 토큰 헤더에 설정
            },
            success: function(response) {
              if (response=='success') {
                alert("주문이 성공적으로 처리되었습니다.");
                location.href = "/payments/confirmation?orderId=" + orderId;
              } else {
                alert("결제 검증 실패");
              }
            },
            error: function(xhr, status, error) {
              // 오류 메시지를 더 구체적으로 출력
              console.error("AJAX 요청 실패:", status, error);
              alert("주문 정보 저장에 실패했습니다.");
            }
          });
        } else {
          alert("결제 실패: " + rsp.error_msg);
          location.href = "/";

        }
      });
  });
 }
</script>
</body>
</html>
