<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>비밀번호 확인</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="container">
    <h2 class="mt-4">비밀번호 확인</h2>
    <input type="password" id="password" placeholder="비밀번호 입력" class="form-control mt-2"/>
    <button class="btn btn-primary mt-2" onclick="checkPassword()">확인</button>
    <button class="btn btn-secondary mt-2" onclick="window.close()">닫기</button>
</div>

<script>
    async function checkPassword() {
        const password = $('#password').val();
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        const response = await fetch('/members/checkPassword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({ password }),
        });

        const result = await response.json(); // JSON 형식으로 응답 받기

        if (result.valid) {
            // 비밀번호가 맞으면 부모 창의 URL을 회원정보수정으로 변경
            window.opener.location.href = '/members/memberUpdate';
            window.close(); // 현재 팝업창을 닫기
        } else {
            alert('비밀번호가 일치하지 않습니다.'); // 비밀번호가 틀리면 오류 메시지 표시
            window.close(); // 팝업창 닫기
            window.opener.location.href = '/members/myPage'; // 마이페이지로 리다이렉션
        }
    }
</script>
</body>
</html>
