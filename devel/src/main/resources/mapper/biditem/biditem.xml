<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.treasuredigger.devel.mapper.BidItemMapper">

    <!-- 공통 쿼리 설정 -->
    <sql id="BaseBidItemQuery">
        SELECT
        btt.bid_item_id AS bidItemId,
        btt.bid_item_name AS bidItemName,
        btt.bid_item_desc AS bidItemDesc,
        btt.start_price AS startPrice,
        btt.max_price AS maxPrice,
        btt.bid_start_date AS bidStartDate,
        btt.bid_end_date AS bidEndDate,
        btt.item_status AS itemStatus,
        btt.created_by AS memberId,
        btt.cid AS itemCategoryId,
        bii.bid_img_name AS bidImgName,
        bii.bid_img_url AS bidImgUrl,
        bii.bid_ori_img_name AS bidOriImgName,
        (SELECT MAX(bt.bid_reg_price)
        FROM bids_tbl bt
        WHERE bt.bid_item_id = btt.bid_item_id) AS bidNowPrice,
        (SELECT count(bt.bid_reg_price)
        FROM bids_tbl bt
        WHERE bt.bid_item_id = btt.bid_item_id) AS bidcount,
        mg.mgid AS mgId,
        mg.member_grade_status AS mgst
        FROM bid_items_tbl btt
        JOIN bid_item_img bii ON btt.bid_item_id = bii.bid_item_id
        LEFT JOIN member_grade_tbl mg ON btt.member_id = mg.member_id
        WHERE bii.bid_repimg_yn = 'Y'







    </sql>

    <!-- 검색 기능 쿼리 -->
    <select id="selectBidList" resultType="com.treasuredigger.devel.dto.BidItemDto">
        <include refid="BaseBidItemQuery" />
        <if test="searchQuery != null and searchQuery != ''">
            AND (btt.bid_item_name LIKE CONCAT('%', #{searchQuery}, '%')
            OR btt.bid_item_desc LIKE CONCAT('%', #{searchQuery}, '%'))
        </if>
        ORDER BY btt.bid_end_date
        LIMIT #{pageable.offset}, #{pageable.pageSize}
    </select>

    <!-- 검색 조건을 포함한 총 항목 수를 구하는 쿼리 -->
    <select id="countBidItems" resultType="int">
        SELECT COUNT(*)
        FROM bid_items_tbl btt
        JOIN bid_item_img bii ON btt.bid_item_id = bii.bid_item_id
        WHERE bii.bid_repimg_yn = 'Y'
        <if test="searchQuery != null and searchQuery != ''">
            AND (btt.bid_item_name LIKE CONCAT('%', #{searchQuery}, '%')
            OR btt.bid_item_desc LIKE CONCAT('%', #{searchQuery}, '%'))
        </if>
    </select>

    <!-- 상세보기 기능 쿼리 -->
    <select id="selectBidItemById" resultType="com.treasuredigger.devel.dto.BidItemDto">
        <include refid="BaseBidItemQuery" />
        AND btt.bid_item_id = #{bidItemId}
    </select>

</mapper>
